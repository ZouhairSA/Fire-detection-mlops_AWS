<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FireVision Dashboard Pro</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background: #0d1117;
            color: white;
        }
        .upload-box {
            border: 2px dashed #6c757d;
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
        }
        .preview-img {
            width: 100%;
            max-height: 380px;
            object-fit: contain;
            margin-top: 15px;
            border-radius: 10px;
        }
        .delete-icon {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            color: red;
            cursor: pointer;
            display: none;
        }
        #preview-container {
            position: relative;
            display: none;
        }
        /* Camera popup */
        #cameraModal {
            display:none;
            position:fixed;
            top:0; left:0;
            width:100%; height:100%;
            background:rgba(0,0,0,.85);
            padding-top:50px;
            text-align:center;
            z-index:9999;
        }
        #cameraStream {
            width:90%;
            max-width:450px;
            border-radius:10px;
        }
    </style>
</head>

<body>
<div class="container py-5">
    <h2 class="text-center mb-4">üî• FireVision</h2>

    <form method="POST" enctype="multipart/form-data">

        <!-- Upload Box -->
        <label class="upload-box w-100" id="uploadArea">
            <i class="bi bi-cloud-upload fs-1"></i>
            <p>Cliquez pour choisir une image</p>
            <input type="file" name="image" id="imageInput" accept="image/*" hidden>
        </label>

        <!-- Bouton Cam√©ra -->
        <button type="button" class="btn btn-secondary w-100 mt-3" onclick="openCamera()">
            üì∑ Prendre une photo
        </button>

        <!-- Preview -->
        <div id="preview-container">
            <i class="bi bi-x-circle delete-icon" id="deleteImage" onclick="removeImage()"></i>
            <img id="preview" class="preview-img">
        </div>

        <!-- Cam√©ra Modal -->
        <div id="cameraModal">
            <video id="cameraStream" autoplay playsinline></video>

            <br><br>
            <button type="button" class="btn btn-success" onclick="capturePhoto()">üì∏ Capturer</button>
            <button type="button" class="btn btn-danger" onclick="closeCamera()">‚ùå Fermer</button>

            <canvas id="cameraCanvas" style="display:none;"></canvas>
        </div>

        <!-- Hidden input for base64 -->
        <input type="hidden" name="camera_image" id="camera_image">

        <button class="btn btn-primary w-100 mt-3">Analyser</button>

    </form>

    {% if annotated %}
        <h3 class="mt-5">üìä R√©sultat :</h3>
        <img src="{{ annotated }}" class="img-fluid mt-3">

        <a href="/download_pdf?results={{ results }}&image={{ image_path }}"
           class="btn btn-warning w-100 mt-4">
            üìÑ T√©l√©charger le rapport PDF
        </a>
    {% endif %}

</div>

<script>
    const imageInput = document.getElementById("imageInput");
    const preview = document.getElementById("preview");
    const previewContainer = document.getElementById("preview-container");
    const deleteIcon = document.getElementById("deleteImage");

    // Upload
    document.getElementById("uploadArea").onclick = () => imageInput.click();

    imageInput.addEventListener("change", function() {
        if (this.files && this.files[0]) {
            let imgUrl = URL.createObjectURL(this.files[0]);
            showPreview(imgUrl);
        }
    });

    function showPreview(src) {
        preview.src = src;
        previewContainer.style.display = "block";
        deleteIcon.style.display = "block";
    }

    function removeImage() {
        imageInput.value = "";
        previewContainer.style.display = "none";
        preview.src = "";
        deleteIcon.style.display = "none";
        document.getElementById("camera_image").value = "";
    }

    // -----------------------
    // CAMERA SYSTEM FIXED
    // -----------------------

    let stream;

    function openCamera() {
        document.getElementById("cameraModal").style.display = "block";

        navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "environment"  // Utilise la cam√©ra arri√®re mobile
            }
        })
        .then(s => {
            stream = s;
            document.getElementById("cameraStream").srcObject = stream;
        })
        .catch(err => {
            alert("‚ö†Ô∏è Autorisez la cam√©ra !\n" + err);
            closeCamera();
        });
    }

    function capturePhoto() {
        let video = document.getElementById("cameraStream");
        let canvas = document.getElementById("cameraCanvas");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        let ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        let dataURL = canvas.toDataURL("image/png");

        document.getElementById("camera_image").value = dataURL;

        showPreview(dataURL);
        closeCamera();
    }

    function closeCamera() {
        document.getElementById("cameraModal").style.display = "none";
        if (stream) stream.getTracks().forEach(t => t.stop());
    }
</script>

</body>
</html>









<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fire Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-5">
    <h1 class="mb-4 text-center">üî• Fire Detection üî•</h1>

    <form method="POST" enctype="multipart/form-data" class="mb-4">
        <div class="mb-3">
            <input type="file" class="form-control" name="image" required>
        </div>
        <button type="submit" class="btn btn-danger w-100">Upload & Predict</button>
    </form>

    {% if image_path %}
    <div class="text-center mb-4">
        <h4>Image Uploaded:</h4>
        <img src="{{ image_path }}" alt="Uploaded Image" class="img-fluid rounded" style="max-height:400px;">
    </div>
    {% endif %}

    {% if results %}
    <div class="card p-3">
        <h4>Predictions:</h4>
        <ul class="list-group list-group-flush">
            {% for r in results %}
            <li class="list-group-item">
                <strong>{{ r.class }}</strong> ‚Äî Confidence: {{ r.confidence }}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
</body>
</html> -->
